<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %} {% endblock %}</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom fonts */
        .font-orbitron {
            font-family: 'Orbitron', sans-serif;
        }

        .font-roboto {
            font-family: 'Roboto', sans-serif;
        }

        /* Basic animation for fade-in */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-down {
            animation: fadeInDown 0.6s ease-out forwards;
        }

        /* Theme variables */
        :root {
            --bg-color: rgba(17, 24, 39, 1);
            /* gray-900 (dark default) */
            --text-color: #e5e7eb;
            /* gray-200 */
            --sidebar-bg: #2d3748;
            /* gray-800 */
            --sidebar-text: #d1d5db;
            /* gray-300 */
            --sidebar-hover: #4a5568;
            /* gray-700 */
            --card-bg: rgba(17, 24, 39, 1);
            --card-border: #4a5568;
            /* gray-700 */
            --accent-color: #3b82f6;
            /* blue-600 */
            --button-bg: #3b82f6;
            /* blue-600 */
            --button-hover: #2563eb;
            /* blue-700 */
            --hover-text: #ffffff;
            /* white for hover contrast */
        }

        .light-mode {
            --bg-color: #f3f4f6;
            /* gray-100 (light blackish) */
            --text-color: #374151;
            /* gray-800 (blackish text) */
            --sidebar-bg: #e5e7eb;
            /* gray-200 */
            --sidebar-text: #4b5563;
            /* gray-700 */
            --sidebar-hover: #d1d5db;
            /* gray-300 */
            --card-bg: #ffffff;
            /* white (lightest blackish) */
            --card-border: #9ca3af;
            /* gray-400 */
            --accent-color: #1e40af;
            /* blue-900 */
            --button-bg: #2563eb;
            /* blue-700 */
            --button-hover: #1d4ed8;
            /* blue-800 */
            --hover-text: #ffffff;
            /* white for hover contrast */
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        aside {
            background-color: var(--sidebar-bg);
            border-right-color: var(--card-border);
        }

        aside nav a {
            color: var(--sidebar-text);
        }

        aside nav a:hover {
            background-color: var(--sidebar-hover);
            color: var(--hover-text) !important;
            /* Ensure white text on hover */
        }

        aside nav a.bg-blue-600 {
            background-color: var(--button-bg) !important;
            color: white !important;
        }

        .bg-gray-800,
        .bg-gray-900 {
            background-color: var(--card-bg) !important;
        }

        .border-blue-700 {
            border-color: var(--accent-color) !important;
        }

        .text-blue-400 {
            color: var(--accent-color) !important;
        }

        .bg-blue-600 {
            background-color: var(--button-bg) !important;
        }

        .hover\:bg-blue-700:hover {
            background-color: var(--button-hover) !important;
        }

        .text-gray-100,
        .text-gray-200 {
            color: var(--text-color) !important;
        }

        .text-gray-300 {
            color: var(--sidebar-text) !important;
        }

        #ai-modal,
        .message div div:last-child {
            background-color: var(--card-bg) !important;
        }

        #ai-input {
            background-color: var(--card-bg) !important;
            border-color: var(--accent-color) !important;
            color: var(--text-color) !important;
            /* Blackish text in light mode */
        }

        .message div div:last-child {
            color: var(--text-color) !important;
            /* Blackish text for messages in light mode */
        }
    </style>
</head>

<body class="dark-mode font-roboto">
    <div id="page-loader"
        class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-90 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <div class="relative">
                <span
                    class="absolute inline-flex h-full w-full rounded-full bg-blue-600 opacity-75 animate-ping"></span>
                <span class="relative inline-flex rounded-full h-16 w-16 bg-blue-600 flex items-center justify-center">
                    <i class="fas fa-robot text-white text-3xl"></i>
                </span>
            </div>
            <span class="mt-6 text-blue-400 font-orbitron text-xl tracking-widest animate-pulse">Loading
                TaskVO...</span>
        </div>
    </div>
    <!-- Sidebar Navigation -->
    <aside class="fixed top-0 left-0 h-full w-64 shadow-xl flex flex-col p-6 rounded-r-2xl z-40">
        <div class="mb-10">
            <h1 class="text-3xl font-orbitron font-extrabold text-blue-400">taskVO</h1>
        </div>
        <nav class="flex-1 space-y-4">
            <a href="{% url 'core:dashboard' %}"
                class="flex items-center space-x-3 px-4 py-3 rounded-lg text-lg font-semibold transition-colors duration-300 bg-blue-600 text-white shadow-md">
                <i class="fas fa-home"></i> <span>Home</span>
            </a>
            <a href="{% url 'core:tasks' %}"
                class="flex items-center space-x-3 px-4 py-3 rounded-lg text-lg font-semibold transition-colors duration-300 hover:bg-gray-700 text-gray-200">
                <i class="fas fa-tasks"></i> <span>Tasks</span>
            </a>
            <a href="{% url 'core:calendar_page' %}"
                class="flex items-center space-x-3 px-4 py-3 rounded-lg text-lg font-semibold transition-colors duration-300 hover:bg-gray-700 text-gray-200">
                <i class="fas fa-calendar-alt"></i> <span>Calendar</span>
            </a>
            <a href="{% url 'core:ai_center' %}"
                class="flex items-center space-x-3 px-4 py-3 rounded-lg text-lg font-semibold transition-colors duration-300 hover:bg-gray-700 text-gray-200">
                <i class="fas fa-robot"></i> <span>AI Command</span>
            </a>
            <a href="{% url 'core:notifications' %}"
                class="flex items-center space-x-3 px-4 py-3 rounded-lg text-lg font-semibold transition-colors duration-300 hover:bg-gray-700 text-gray-200">
                <i class="fas fa-bell"></i> <span>Notifications</span>
            </a>
            <a href="{% url 'core:settings' %}"
                class="flex items-center space-x-3 px-4 py-3 rounded-lg text-lg font-semibold transition-colors duration-300 hover:bg-gray-700 text-gray-200">
                <i class="fas fa-cog"></i> <span>Settings</span>
            </a>
            <a href="{% url 'users:logout' %}"
                class="flex items-center space-x-3 px-4 py-3 rounded-lg text-lg font-semibold transition-colors duration-300 hover:bg-gray-700 text-gray-200">
                <i class="fas fa-sign-out"></i> <span>Logout</span>
            </a>
        </nav>
        <div class="mt-auto text-center text-sm text-gray-500">
            <p>User ID: <span id="userIdDisplay">user-great-12345</span></p>
        </div>
    </aside>
    <main class="flex-1 ml-64 relative">
        <div class="absolute top-6 right-6 z-30">
            <div class="bg-gray-800 text-gray-200 rounded-lg px-5 py-2 shadow-md flex flex-col items-end">
                <div class="flex items-center space-x-2 mb-1">
                    <i class="fas fa-award text-yellow-400"></i>
                    <span class="font-semibold text-lg">Current Plan: <span class="text-blue-400">{{ current_plan|title }}</span></span>
                </div>
                {% if current_plan == 'free' %}
                <a href="{% url 'core:payment_page' %}" class="text-sm text-blue-300 hover:text-blue-200 hover:underline mt-1">Upgrade Plan</a>
                {% endif %}
            </div>
        </div>
        {% block content %} {% endblock %}
    </main>

    <!-- AI Assistant Floating Button and Modal -->
    <div id="ai-assistant-root">
        <!-- Floating Button -->
        <button id="ai-fab"
            class="fixed bottom-8 right-8 z-50 bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-lg w-16 h-16 flex items-center justify-center text-3xl transition-all duration-300 focus:outline-none focus:ring-4 focus:ring-blue-400"
            aria-label="Open AI Assistant">
            <i class="fas fa-robot"></i>
        </button>

        <!-- Modal/Window -->
        <div id="ai-modal"
            class="fixed bottom-32 right-12 z-50 border border-blue-600 rounded-2xl shadow-2xl w-[30rem] max-w-full p-8 animate-fade-in-down hidden"
            style="min-height: 240px;">
            <div class="flex items-center mb-6">
                <div
                    class="bg-blue-600 text-white rounded-full w-12 h-12 flex items-center justify-center text-3xl mr-4">
                    <i class="fas fa-robot"></i>
                </div>
                <span class="text-xl font-bold font-orbitron text-blue-400">taskVO AI</span>
                <button id="ai-close" class="ml-auto text-gray-400 hover:text-blue-400 text-2xl focus:outline-none"
                    aria-label="Close AI Assistant">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-6">
                <p class="text-gray-200 font-semibold text-lg">What do you want me to perform?</p>
            </div>
            <div class="message flex flex-col gap-6 max-h-60 overflow-y-auto pr-2 mb-4">
                <!-- Messages will appear here -->
            </div>
            <!-- AI Loader -->
            <div id="ai-loader" class="flex items-center gap-3 mb-4 pl-2 hidden">
                <span class="inline-flex h-8 w-8 rounded-full bg-blue-600 opacity-75 animate-ping"></span>
                <span class="relative inline-flex rounded-full h-8 w-8 bg-blue-600 flex items-center justify-center">
                    <i class="fas fa-robot text-white text-xl"></i>
                </span>
                <span class="text-blue-400 font-orbitron text-base animate-pulse">Thinking...</span>
            </div>
            <form id="ai-form" class="flex items-center gap-3" method="post" action="{% url 'core:ai_command' %}">
                {% csrf_token %}
                <input type="text" id="ai-input"
                    class="flex-1 p-4 rounded-lg border border-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-lg transition"
                    placeholder="Type your command..." autocomplete="off" name="user-input" />
                <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-3 rounded-lg font-semibold shadow transition text-lg">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>
    </div>

    <script>
        window.addEventListener('load', function () {
            const loader = document.getElementById('page-loader');
            if (loader) {
                loader.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => loader.style.display = 'none', 400);
            }
        });
        document.addEventListener('DOMContentLoaded', () => {
            // Theme switching logic
            const themeControls = document.getElementById('theme-controls');
            const themeRadios = document.querySelectorAll('input[name="theme"]');
            let currentTheme = localStorage.getItem('taskvo-theme') || 'dark';

            function applyTheme(theme) {
                document.body.classList.remove('dark-mode', 'light-mode');
                document.body.classList.add(theme + '-mode');
                localStorage.setItem('taskvo-theme', theme);
                currentTheme = theme;
                themeRadios.forEach(radio => {
                    if (radio.value === theme) radio.checked = true;
                });
            }

            // Apply saved theme on load
            applyTheme(currentTheme);

            // Live theme change on radio click
            themeRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    if (radio.checked) {
                        applyTheme(radio.value);
                    }
                });
            });

            // Existing navigation highlight logic
            const currentPath = window.location.pathname;
            document.querySelectorAll('aside nav a').forEach(link => {
                const linkPath = link.getAttribute('href');
                if (currentPath === linkPath || (currentPath === '/' && linkPath === '/dashboard.html')) {
                    link.classList.add('bg-blue-600', 'text-white', 'shadow-md');
                    link.classList.remove('hover:bg-gray-700', 'text-gray-200');
                } else {
                    link.classList.remove('bg-blue-600', 'text-white', 'shadow-md');
                    link.classList.add('hover:bg-gray-700', 'text-gray-200');
                }
            });

            // AI Assistant logic
            const fab = document.getElementById('ai-fab');
            const modal = document.getElementById('ai-modal');
            const closeBtn = document.getElementById('ai-close');
            const aiInput = document.getElementById('ai-input');
            const aiForm = document.getElementById('ai-form');
            const aiLoader = document.getElementById('ai-loader');
            const messageContainer = document.querySelector('.message');

            fab.addEventListener('click', () => {
                modal.classList.remove('hidden');
                setTimeout(() => aiInput.focus(), 200);
            });

            closeBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            document.addEventListener('mousedown', (e) => {
                if (!modal.contains(e.target) && !fab.contains(e.target)) {
                    modal.classList.add('hidden');
                }
            });

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let cookie of cookies) {
                        cookie = cookie.trim();
                        if (cookie.startsWith(name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function addMessage(text, sender = "user") {
                const wrapper = document.createElement('div');
                wrapper.className = `flex items-start gap-3 ${sender === "user" ? "justify-end" : "justify-start"}`;

                if (sender === "user") {
                    wrapper.innerHTML = `
                        <div class="flex items-center gap-2">
                            <div class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="bg-blue-700 text-gray-800 px-4 py-2 rounded-2xl shadow font-medium max-w-xs break-words">${text}</div>
                        </div>
                    `;
                } else {
                    wrapper.innerHTML = `
                        <div class="flex items-center gap-2">
                            <div class="bg-blue-600 text-white rounded-full w-8 h-8 flex items-center justify-center text-lg">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="bg-gray-700 text-gray-800 px-4 py-2 rounded-2xl shadow font-medium max-w-xs break-words">${text}</div>
                        </div>
                    `;
                }
                messageContainer.appendChild(wrapper);
                messageContainer.scrollTop = messageContainer.scrollHeight;
            }

            aiForm.addEventListener('submit', function (e) {
                e.preventDefault();
                const user_message = aiInput.value.trim();
                if (!user_message) return;

                addMessage(user_message, "user");
                aiInput.value = "";

                // Show AI loader
                aiLoader.classList.remove('hidden');

                fetch("{% url 'core:ai_command' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ 'user_message': user_message })
                })
                    .then(response => response.json())
                    .then(data => {
                        // Hide AI loader
                        aiLoader.classList.add('hidden');
                        addMessage(data.message, "ai");
                    })
                    .catch(() => {
                        aiLoader.classList.add('hidden');
                        addMessage("Sorry, something went wrong.", "ai");
                    });
            });
        });
    </script>
</body>

</html>